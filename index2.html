<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Upload Excel → Ke Database</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      body {
        padding: 24px;
        background: #f8f9fa;
      }
      .card {
        max-width: 960px;
        margin: 0 auto 32px;
      }
      pre {
        max-height: 200px;
        overflow: auto;
        background: #0f172a;
        color: #e6eef8;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container"> <a href="index.html" class="btn btn-outline-primary shadow mb-4">
          Home
        </a></div>
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="card-title mb-3">
          Import Excel → Firebase Realtime Database
        </h4>
       

        <!-- Pilihan Tahun & Bulan -->
        <div class="mb-3 row gx-2">
          <label class="col-auto col-form-label">Pilih Tahun</label>
          <div class="col-auto">
            <select id="tahunSelect" class="form-select">
              <option value="2025" selected>2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </div>

          <label class="col-auto col-form-label">Pilih Bulan</label>
          <div class="col-auto">
            <select id="bulanSelect" class="form-select">
              <option value="januari">Januari</option>
              <option value="februari">Februari</option>
              <option value="maret">Maret</option>
              <option value="april">April</option>
              <option value="mei">Mei</option>
              <option value="juni">Juni</option>
              <option value="juli">Juli</option>
              <option value="agustus">Agustus</option>
              <option value="september">September</option>
              <option value="oktober">Oktober</option>
              <option value="november">November</option>
              <option value="desember">Desember</option>
            </select>
          </div>
        </div>

        <!-- Input File -->
        <div class="mb-3">
          <label class="form-label">Pilih file Excel (.xlsx, .xls, .csv)</label>
          <input
            id="fileInput"
            type="file"
            accept=".xlsx,.xls,.csv"
            class="form-control"
          />
        </div>

        <!-- Tombol -->
        <div class="mb-3 d-flex gap-2">
          <button id="previewBtn" class="btn btn-outline-primary">
            Preview File
          </button>
          <button id="uploadBtn" class="btn btn-primary">
            Upload ke Firebase
          </button>
          <button id="clearLogBtn" class="btn btn-light">Clear Log</button>
        </div>

        <!-- Progress -->
        <div id="progressWrap" class="mb-3" style="display: none">
          <label class="form-label">Upload Progress</label>
          <div class="progress">
            <div
              id="uploadProgress"
              class="progress-bar"
              role="progressbar"
              style="width: 0%"
            >
              0%
            </div>
          </div>
        </div>

        <!-- Log -->
        <div class="mb-3">
          <label class="form-label">Log</label>
          <pre id="logBox">Menunggu file...</pre>
        </div>
        <div class="mb-3">
          <a href="contoh_pasien.xlsx" class="btn btn-outline-secondary shadow"
            >Download Template</a
          >
        </div>
      </div>
    </div>

    <!-- Rekap Data -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="card-title mb-3">Rekap Data Pasien per Bulan</h4>
        <div class="table-responsive">
          <table
            class="table table-bordered table-striped text-center align-middle"
          >
            <thead class="table-dark">
              <tr>
                <th>Bulan</th>
                <th>Jumlah Data</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="rekapBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Firebase + logic -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        get,
        remove,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCrMmWyZOclX2ILNCmY6T9MBfNhRxaMGLU",
        authDomain: "rekap-data-pasien.firebaseapp.com",
        databaseURL:
          "https://rekap-data-pasien-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "rekap-data-pasien",
        storageBucket: "rekap-data-pasien.firebasestorage.app",
        messagingSenderId: "204017560449",
        appId: "1:204017560449:web:534fd88744504074455680",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // -------------------------
      // Helper konversi tanggal Excel serial number
      // -------------------------
      function excelDateToJSDate(serial) {
        const utc_days = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400;
        const date_info = new Date(utc_value * 1000);
        const year = date_info.getUTCFullYear();
        const month = String(date_info.getUTCMonth() + 1).padStart(2, "0");
        const day = String(date_info.getUTCDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function normalizeDate(val) {
        if (!val) return "";
        if (val instanceof Date) {
          return val.toISOString().split("T")[0];
        }
        if (typeof val === "number") {
          return excelDateToJSDate(val);
        }
        if (typeof val === "string") {
          let parts = val.split(/[\/\-]/);
          if (parts.length === 3) {
            let d, m, y;
            if (val.includes("/")) {
              d = parts[0];
              m = parts[1];
              y = parts[2];
            } else {
              y = parts[0];
              m = parts[1];
              d = parts[2];
            }
            if (y.length === 2) y = "20" + y;
            if (d.length === 1) d = "0" + d;
            if (m.length === 1) m = "0" + m;
            return `${y}-${m}-${d}`;
          }
        }
        return String(val).trim();
      }

      // -------------------------
      // Sanitize Header & Row
      // -------------------------
      function sanitizeKey(key) {
        if (key === null || key === undefined) return null;
        const trimmed = String(key).trim();
        if (!trimmed) return null;
        let k = trimmed.replace(/\s+/g, "_").replace(/\//g, "_");
        k = k.replace(/[$#\[\]\.\/]/g, "");
        return k === "" ? null : k;
      }

      function sanitizeRow(row) {
        const newRow = {};
        for (const rawKey in row) {
          const newKey = sanitizeKey(rawKey);
          if (!newKey) continue;
          let val = row[rawKey];

          // jika kolom ada kata "tanggal" → normalisasi
          if (newKey.toLowerCase().includes("tanggal")) {
            val = normalizeDate(val);
          }

          newRow[newKey] = val;
        }
        return newRow;
      }

      // -------------------------
      // Log Helper
      // -------------------------
      const logBox = document.getElementById("logBox");
      function log(...args) {
        const t = new Date().toLocaleTimeString();
        logBox.textContent =
          `${t} — ${args
            .map((a) => (typeof a === "object" ? JSON.stringify(a) : String(a)))
            .join(" ")}\n` + logBox.textContent;
      }

      // -------------------------
      // Parse Excel
      // -------------------------
      let lastParsedRows = null;
      document
        .getElementById("previewBtn")
        .addEventListener("click", async () => {
          const f = document.getElementById("fileInput").files[0];
          if (!f) return alert("Pilih file dulu.");
          try {
            const rows = await parseExcelFile(f);
            lastParsedRows = rows;
            log(`Preview: ${rows.length} baris`, rows[0] || {});
            alert(`Preview selesai: ${rows.length} baris`);
          } catch (err) {
            log("Error preview:", err.message || err);
          }
        });

      async function parseExcelFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array" });
              const sheet = workbook.Sheets[workbook.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
              resolve(json);
            } catch (err) {
              reject(err);
            }
          };
          reader.onerror = (err) => reject(err);
          reader.readAsArrayBuffer(file);
        });
      }

      // -------------------------
      // Upload Excel → Firebase
      // -------------------------
      document
        .getElementById("uploadBtn")
        .addEventListener("click", async () => {
          const f = document.getElementById("fileInput").files[0];
          if (!f) return alert("Pilih file terlebih dahulu.");

          const tahun = document.getElementById("tahunSelect").value || "2025";
          const bulan = document.getElementById("bulanSelect").value || "mei";

          let rows;
          try {
            rows = lastParsedRows ? lastParsedRows : await parseExcelFile(f);
          } catch (err) {
            log("Gagal parse file:", err.message || err);
            return;
          }
          if (!rows.length) return alert("File kosong");

          const sanitized = rows
            .map((r) => sanitizeRow(r))
            .filter((r) => Object.keys(r).length > 0);

          const progressWrap = document.getElementById("progressWrap");
          const progressBar = document.getElementById("uploadProgress");
          progressWrap.style.display = "block";

          let uploaded = 0;
          const baseRefPath = `pasien/${tahun}/${bulan}`;
          try {
            for (let i = 0; i < sanitized.length; i++) {
              const newRef = push(ref(db, baseRefPath));
              await set(newRef, sanitized[i]);
              uploaded++;
              const pct = Math.round((uploaded / sanitized.length) * 100);
              progressBar.style.width = pct + "%";
              progressBar.textContent = pct + "%";
            }
            log(`Upload selesai: ${uploaded} baris`);
            loadRekap(); // refresh tabel
          } catch (err) {
            log("Error upload:", err.message || err);
          } finally {
            setTimeout(() => {
              progressWrap.style.display = "none";
            }, 1200);
          }
        });

      document.getElementById("clearLogBtn").addEventListener("click", () => {
        logBox.textContent = "";
      });

      // -------------------------
      // Rekap Data per Bulan
      // -------------------------
      const bulanList = [
        "januari",
        "februari",
        "maret",
        "april",
        "mei",
        "juni",
        "juli",
        "agustus",
        "september",
        "oktober",
        "november",
        "desember",
      ];

      async function loadRekap() {
        const tbody = document.getElementById("rekapBody");
        tbody.innerHTML = "";
        const tahun = document.getElementById("tahunSelect").value || "2025";

        for (const bulan of bulanList) {
          const dbRef = ref(db, `pasien/${tahun}/${bulan}`);
          const snapshot = await get(dbRef);

          let jumlah = 0;
          if (snapshot.exists()) {
            jumlah = Object.keys(snapshot.val()).length;
          }

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${bulan.charAt(0).toUpperCase() + bulan.slice(1)}</td>
            <td>${jumlah}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="hapusBulan('${tahun}','${bulan}')">
                Hapus
              </button>
            </td>
          `;
          tbody.appendChild(row);
        }
      }

      window.hapusBulan = async function (tahun, bulan) {
        if (!confirm(`Yakin hapus semua data bulan ${bulan} ${tahun}?`)) return;
        try {
          await remove(ref(db, `pasien/${tahun}/${bulan}`));
          alert(`Data bulan ${bulan} ${tahun} terhapus`);
          loadRekap();
        } catch (err) {
          alert("Gagal hapus: " + err.message);
        }
      };

      loadRekap();
    </script>
  </body>
</html>
