<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekap Kunjungan Pasien</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script> -->

    <style>
      .table-responsive {
        overflow-x: auto;
      }
      #tableHead th {
        font-size: 0.75rem;
        padding: 4px;
        white-space: nowrap;
        min-width: 45px;
        max-width: 55px;
        text-align: center;
        vertical-align: middle;
      }
      #dataBody td {
        font-size: 0.8rem;
        padding: 4px;
        text-align: center;
        vertical-align: middle;
      }
      thead.table-dark th {
        position: sticky;
        top: 0;
        z-index: 2;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container my-5">
      <a href="index2.html" class="btn btn-outline-primary shadow"
        >Input Register Pasien</a
      >
      <h2 class="text-center mb-4">Rekap Kunjungan Pasien</h2>
      
      <!-- Pilihan Bulan -->
      <div class="d-flex justify-content-center mb-3">
        <select id="bulanSelect" class="form-select w-auto">
          <option value="">-- Pilih Bulan --</option>
          <option value="mei">Mei 2025</option>
          <option value="juni">Juni 2025</option>
          <option value="juli">Juli 2025</option>
          <option value="agustus">Agustus 2025</option>
        </select>
      </div>

      <!-- Loading dengan Progress -->
      <div id="loading" class="text-center my-3" style="display: none">
        <div class="progress" style="height: 25px">
          <div
            id="progressBar"
            class="progress-bar progress-bar-striped progress-bar-animated"
            role="progressbar"
            style="width: 0%"
          >
            0%
          </div>
        </div>
        <p class="mt-2">Memuat data...</p>
      </div>

      <!-- Konten -->
      <div id="content" style="display: none">
        <div class="table-responsive">
          <table
            class="table table-sm table-bordered table-striped table-hover align-middle text-center"
          >
            <thead class="table-dark" id="tableHead"></thead>
            <tbody id="dataBody"></tbody>
          </table>
        </div>

        <!-- Chart -->
        <div class="card shadow-sm mt-4">
          <div class="card-body">
            <h5 class="card-title">Grafik Kunjungan Pasien</h5>
            <canvas id="kunjunganChart" height="100"></canvas>
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      let chartInstance = null;

      // ðŸ”¹ Konfigurasi Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCrMmWyZOclX2ILNCmY6T9MBfNhRxaMGLU",
        authDomain: "rekap-data-pasien.firebaseapp.com",
        databaseURL:
          "https://rekap-data-pasien-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "rekap-data-pasien",
        storageBucket: "rekap-data-pasien.firebasestorage.app",
        messagingSenderId: "204017560449",
        appId: "1:204017560449:web:534fd88744504074455680",
      };

      // ðŸ”¹ Inisialisasi Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      async function loadData(bulanLabel) {
        try {
          const loadingDiv = document.getElementById("loading");
          const contentDiv = document.getElementById("content");
          const bar = document.getElementById("progressBar");

          loadingDiv.style.display = "block";
          contentDiv.style.display = "none";
          bar.style.width = "0%";
          bar.textContent = "0%";

          // ðŸ”¹ Ambil data dari Firebase
          const dbRef = ref(db, `pasien/2025/${bulanLabel}`);
          const snapshot = await get(dbRef);

          bar.style.width = "70%";
          bar.textContent = "70%";

          if (!snapshot.exists()) {
            console.warn("Data kosong untuk bulan:", bulanLabel);
            document.getElementById("content").style.display = "none";
            loadingDiv.style.display = "none";
            return;
          }

          const rawData = snapshot.val();
          const data = Object.values(rawData); // ubah object ke array

          // ðŸ”¹ Hitung statistik harian
          const dailyStats = {};
          data.forEach((item) => {
            const tgl = new Date(item.Tanggal);
            if (isNaN(tgl)) return;
            const key = `${tgl.getDate()}-${bulanLabel}`;
            if (!dailyStats[key]) {
              dailyStats[key] = { total: 0, bpjs: 0, nonbpjs: 0 };
            }
            dailyStats[key].total++;
            const noBpjs = (item["No_BPJS"] || "").replace(/\D/g, "");
            if (noBpjs !== "") dailyStats[key].bpjs++;
            else dailyStats[key].nonbpjs++;
          });

          const labels = Object.keys(dailyStats);
          const totalPasien = labels.map((l) => dailyStats[l].total);
          const bpjsPasien = labels.map((l) => dailyStats[l].bpjs);
          const nonbpjsPasien = labels.map((l) => dailyStats[l].nonbpjs);

          // ðŸ”¹ Isi tabel
          document.getElementById("tableHead").innerHTML = `
            <tr>
              <th>Keterangan</th>
              ${labels.map((l) => `<th>${l}</th>`).join("")}
            </tr>
          `;
          document.getElementById("dataBody").innerHTML = `
            <tr><td>Total Pasien</td>${totalPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
            <tr><td>Pasien BPJS</td>${bpjsPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
            <tr><td>Pasien Non-BPJS</td>${nonbpjsPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
          `;

          // ðŸ”¹ Render Chart
          const ctx = document
            .getElementById("kunjunganChart")
            .getContext("2d");
          if (chartInstance) chartInstance.destroy();
          chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Total Pasien",
                  data: totalPasien,
                  borderColor: "blue",
                  backgroundColor: "rgba(0,0,255,0.1)",
                  fill: true,
                  tension: 0.3,
                },
                {
                  label: "Pasien BPJS",
                  data: bpjsPasien,
                  borderColor: "green",
                  backgroundColor: "rgba(0,255,0,0.1)",
                  fill: false,
                  tension: 0.3,
                },
                {
                  label: "Pasien Non-BPJS",
                  data: nonbpjsPasien,
                  borderColor: "red",
                  backgroundColor: "rgba(255,0,0,0.1)",
                  fill: false,
                  tension: 0.3,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                title: {
                  display: true,
                  text: `Rekap Pasien ${bulanLabel} 2025`,
                },
              },
              scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } } },
            },
          });

          contentDiv.style.display = "block";
          bar.style.width = "100%";
          bar.textContent = "100%";
        } catch (error) {
          console.error("Firebase fetch error:", error);
        } finally {
          setTimeout(() => {
            document.getElementById("loading").style.display = "none";
          }, 800);
        }
      }

      // Event listener dropdown
      document
        .getElementById("bulanSelect")
        .addEventListener("change", function () {
          const bulan = this.value;
          if (bulan) {
            loadData(bulan);
          } else {
            document.getElementById("content").style.display = "none";
          }
        });
    </script>
  </body>
</html>
