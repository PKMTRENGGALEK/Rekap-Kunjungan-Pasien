<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rekap Kunjungan Pasien</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- <script src="auth.js"></script> -->
    <style>
      body {
        background: linear-gradient(135deg, #f8f8f8, #99a3c2);
        min-height: 100vh;
      }
      .card {
        border-radius: 20px;
        border: none;
      }
      .header-title {
        background: linear-gradient(90deg, #175c06, #60812a);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-weight: 800;
      }
      .form-select {
        border-radius: 12px;
      }
      .form-select:disabled {
        background-color: #f3f4f6;
        color: #9ca3af;
        cursor: not-allowed;
      }
      .table-responsive {
        overflow-x: auto;
      }
      #tableHead th {
        font-size: 0.8rem;
        padding: 6px;
        white-space: nowrap;
        text-align: center;
      }
      #dataBody td {
        font-size: 0.85rem;
        padding: 6px;
        text-align: center;
      }
      thead.table-dark th {
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .progress {
        border-radius: 20px;
        overflow: hidden;
      }
      .progress-bar {
        font-weight: bold;
      }
      .shadow-soft {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <a
        href="register.html"
        class="btn btn-outline-danger btn-sm shadow mb-4 rounded"
      >
        ‚ûï Input Register Pasien
      </a>

      <div class="card shadow-soft p-4">
        <h2 class="text-center mb-4 header-title fw-bold">
          Rekap Kunjungan Pasien
        </h2>

        <!-- Pilihan Tahun & Bulan -->
        <div class="row g-3 justify-content-center mb-4">
          <div class="col-auto">
            <div class="input-group shadow-sm">
              <span class="input-group-text bg-light">üìÖ Tahun</span>
              <select id="tahunSelect" class="form-select">
                <option value="">-- Pilih Tahun --</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
          </div>
          <div class="col-auto">
            <div class="input-group shadow-sm">
              <span class="input-group-text bg-light">üóìÔ∏è Bulan</span>
              <select id="bulanSelect" class="form-select">
                <option value="">-- Pilih Bulan --</option>
                <option value="januari">Januari</option>
                <option value="februari">Februari</option>
                <option value="maret">Maret</option>
                <option value="april">April</option>
                <option value="mei">Mei</option>
                <option value="juni">Juni</option>
                <option value="juli">Juli</option>
                <option value="agustus">Agustus</option>
                <option value="september">September</option>
                <option value="oktober">Oktober</option>
                <option value="november">November</option>
                <option value="desember">Desember</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center my-3" style="display: none">
          <div class="progress" style="height: 28px">
            <div
              id="progressBar"
              class="progress-bar progress-bar-striped progress-bar-animated bg-info"
              role="progressbar"
              style="width: 0%"
            >
              0%
            </div>
          </div>
          <p class="mt-2 text-muted">‚è≥ Memuat data...</p>
        </div>

        <!-- Konten -->
        <div id="content" style="display: none">
          <div class="table-responsive shadow-sm rounded">
            <table
              class="table table-sm table-bordered table-striped table-hover align-middle text-center"
            >
              <thead class="table-dark" id="tableHead"></thead>
              <tbody id="dataBody"></tbody>
            </table>
          </div>

          <!-- Chart -->
          <div class="card shadow-soft mt-4">
            <div class="card-body">
              <h5 class="card-title fw-bold text-primary">
                üìà Grafik Kunjungan Pasien
              </h5>
              <canvas id="kunjunganChart" height="120"></canvas>
            </div>
          </div>

          <!-- Diagnosa terbanyak akan ditambahkan di sini -->
          <div id="diagnosaSection"></div>
        </div>
      </div>
      <footer class="text-center fixed-bottom">
        <small class="text-muted">PKM Trenggalek | 2025</small>
      </footer>
    </div>

    <!-- Script Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

      let chartInstance = null;

      // üîπ Konfigurasi Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyCrMmWyZOclX2ILNCmY6T9MBfNhRxaMGLU",
        authDomain: "rekap-data-pasien.firebaseapp.com",
        databaseURL:
          "https://rekap-data-pasien-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "rekap-data-pasien",
        storageBucket: "rekap-data-pasien.firebasestorage.app",
        messagingSenderId: "204017560449",
        appId: "1:204017560449:web:534fd88744504074455680",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // üîπ Mapping ICD-10 sederhana
      const icdMapping = {
        A09: "Diare dan gastroenteritis",
        J18: "Pneumonia",
        I10: "Hipertensi esensial",
        E11: "Diabetes melitus tipe 2",
        B20: "HIV",
        N39: "Infeksi saluran kemih",
        J06: "Infeksi saluran napas atas akut",
        R50: "Demam tidak spesifik",
        K30: "Dispepsia",
        M54: "Nyeri punggung",

        // Tambahan biar 10 besar kamu tidak kosong
        J00: "Nasofaringitis akut (common cold)",
        R51: "Sakit kepala",
        J02: "Faringitis akut",
        Z48: "Perawatan pasca operasi",
        J39: "Penyakit lain saluran napas atas",
        Z23: "Kunjungan imunisasi",
      };

      // üîπ Cek bulan aktif
      async function updateBulanOptions(tahun) {
        const bulanSelect = document.getElementById("bulanSelect");
        const bulanList = bulanSelect.querySelectorAll("option[value]");

        for (const opt of bulanList) {
          if (opt.value === "") continue;
          const dbRef = ref(db, `pasien/${tahun}/${opt.value}`);
          const snapshot = await get(dbRef);
          if (!snapshot.exists()) {
            opt.disabled = true;
            opt.textContent = opt.textContent.replace(" ‚ùå", "") + " ‚ùå";
          } else {
            opt.disabled = false;
            opt.textContent = opt.textContent.replace(" ‚ùå", "");
          }
        }
      }

      // üîπ Load data
      async function loadData(tahun, bulanLabel) {
        try {
          const loadingDiv = document.getElementById("loading");
          const contentDiv = document.getElementById("content");
          const bar = document.getElementById("progressBar");

          loadingDiv.style.display = "block";
          contentDiv.style.display = "none";
          bar.style.width = "0%";
          bar.textContent = "0%";

          const dbRef = ref(db, `pasien/${tahun}/${bulanLabel}`);
          const snapshot = await get(dbRef);

          bar.style.width = "70%";
          bar.textContent = "70%";

          if (!snapshot.exists()) {
            contentDiv.style.display = "none";
            loadingDiv.style.display = "none";
            return;
          }

          const rawData = snapshot.val();
          const data = Object.values(rawData);

          // === Statistik Harian ===
          const dailyStats = {};
          const diagnosaStats = {};

          data.forEach((item) => {
            const tgl = new Date(item.Tanggal);
            if (!isNaN(tgl)) {
              const key = `${tgl.getDate()}-${bulanLabel}`;
              if (!dailyStats[key]) {
                dailyStats[key] = { total: 0, bpjs: 0, nonbpjs: 0 };
              }
              dailyStats[key].total++;
              const noBpjs = (item["No_BPJS"] || "").replace(/\D/g, "");
              if (noBpjs !== "") dailyStats[key].bpjs++;
              else dailyStats[key].nonbpjs++;
            }

            // === Statistik Diagnosa (kode ICD) ===
            for (let i = 1; i <= 5; i++) {
              const d = (item[`Diagnosa${i}`] || "").trim().toUpperCase();
              if (d && /^[A-Z]\d{1,3}[A-Z0-9]?$/.test(d)) {
                diagnosaStats[d] = (diagnosaStats[d] || 0) + 1;
              }
            }
          });

          const labels = Object.keys(dailyStats);
          const totalPasien = labels.map((l) => dailyStats[l].total);
          const bpjsPasien = labels.map((l) => dailyStats[l].bpjs);
          const nonbpjsPasien = labels.map((l) => dailyStats[l].nonbpjs);

          // Isi tabel kunjungan
          document.getElementById("tableHead").innerHTML = `
            <tr>
              <th>Keterangan</th>
              ${labels.map((l) => `<th>${l}</th>`).join("")}
            </tr>
          `;
          document.getElementById("dataBody").innerHTML = `
            <tr><td>Total Pasien</td>${totalPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
            <tr><td>Pasien BPJS</td>${bpjsPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
            <tr><td>Pasien Non-BPJS</td>${nonbpjsPasien
              .map((v) => `<td>${v}</td>`)
              .join("")}</tr>
          `;

          // Render Chart Kunjungan
          const ctx = document
            .getElementById("kunjunganChart")
            .getContext("2d");
          if (chartInstance) chartInstance.destroy();
          chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Total Pasien",
                  data: totalPasien,
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37,99,235,0.15)",
                  fill: true,
                  tension: 0.4,
                  pointBackgroundColor: "#2563eb",
                },
                {
                  label: "Pasien BPJS",
                  data: bpjsPasien,
                  borderColor: "#16a34a",
                  backgroundColor: "rgba(22,163,74,0.1)",
                  fill: false,
                  tension: 0.4,
                  pointBackgroundColor: "#16a34a",
                },
                {
                  label: "Pasien Non-BPJS",
                  data: nonbpjsPasien,
                  borderColor: "#dc2626",
                  backgroundColor: "rgba(220,38,38,0.1)",
                  fill: false,
                  tension: 0.4,
                  pointBackgroundColor: "#dc2626",
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { position: "top" },
                title: {
                  display: true,
                  text: `Rekap Pasien ${bulanLabel} ${tahun}`,
                },
              },
              scales: { x: { ticks: { autoSkip: true, maxTicksLimit: 10 } } },
            },
          });

          // === Diagnosa Terbanyak ===
          const topDiagnosa = Object.entries(diagnosaStats)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

          const diagnosaTable = `
            <div class="card shadow-soft mt-4">
              <div class="card-body">
                <h5 class="card-title fw-bold text-success">ü©∫ 10 Diagnosa Terbanyak</h5>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered align-middle text-center">
                    <thead class="table-dark">
                      <tr><th>Kode</th><th>Nama Diagnosa</th><th>Jumlah Kasus</th></tr>
                    </thead>
                    <tbody>
                      ${topDiagnosa
                        .map(
                          ([code, count]) =>
                            `<tr><td>${code}</td><td>${
                              icdMapping[code] || "-"
                            }</td><td>${count}</td></tr>`
                        )
                        .join("")}
                    </tbody>
                  </table>
                </div>
                <canvas id="diagnosaChart" height="150"></canvas>
              </div>
            </div>
          `;
          document.getElementById("diagnosaSection").innerHTML = diagnosaTable;

          // Chart Bar Diagnosa
          const diagCtx = document
            .getElementById("diagnosaChart")
            .getContext("2d");
          new Chart(diagCtx, {
            type: "bar",
            data: {
              labels: topDiagnosa.map((d) => d[0]),
              datasets: [
                {
                  label: "Jumlah Kasus",
                  data: topDiagnosa.map((d) => d[1]),
                  backgroundColor: "rgba(22,163,74,0.6)",
                },
              ],
            },
            options: {
              indexAxis: "y",
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: true, text: "10 Diagnosa Terbanyak" },
              },
            },
          });

          contentDiv.style.display = "block";
          bar.style.width = "100%";
          bar.textContent = "100%";
        } catch (error) {
          console.error("Firebase fetch error:", error);
        } finally {
          setTimeout(() => {
            document.getElementById("loading").style.display = "none";
          }, 800);
        }
      }

      // üîπ Event
      document.getElementById("tahunSelect").addEventListener("change", (e) => {
        const tahun = e.target.value;
        if (tahun) {
          updateBulanOptions(tahun);
          document.getElementById("bulanSelect").value = "";
          document.getElementById("content").style.display = "none";
        }
      });

      document.getElementById("bulanSelect").addEventListener("change", (e) => {
        const bulan = e.target.value;
        const tahun = document.getElementById("tahunSelect").value;
        if (bulan && tahun) {
          loadData(tahun, bulan);
        } else {
          document.getElementById("content").style.display = "none";
        }
      });
    </script>
  </body>
</html>
